<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品列表</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css" rel="stylesheet">



    <style>
        /* 为包含"删除全部"按钮的<div>元素添加样式 */
        .delete-all-button {
            position: absolute;
            top: 30px;
            right: 75px;
            padding: 10px;
        }

        /* 为表格的列添加样式以确保按钮不会遮挡内容 */
        .table th,
        .table td {
            position: relative;
        }

        /* 样式用于购物车为空消息 */
        #emptyCartMessage {
            display: none;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 使用伪元素添加空购物车图标 */
        #emptyCartMessage::before {
            content: "\1F6D2";
            /* Unicode字符编码，这里使用购物车图标 */
            font-size: 100px;
            display: block;
        }

        #backtoshop {
            position: absolute;
            top: 30px;
            right: 180px;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="productInfo">
        <form id="cartForm" method="POST" action="/Cart">
            <!-- 添加一個隱藏的 input 元素來接收商品 JSON 數據 -->
            <input type="hidden" name="productJson" id="productJson">
            <!-- 其他購物車內容，例如商品列表、總價格等 -->
            <button type="submit">結帳</button> <!-- 提交表單按鈕，當用戶結帳時使用 -->
        </form>
    </div>
    <div class="container">
        <h1>商品列表</h1>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" id="selectAll" checked> <label class="form-check-label"
                for="selectAll">全選</label>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>商品名稱</th>
                    <th>價格</th>
                    <th>描述</th>
                    <th>數量</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>
        <div class="totalPrice">
            <strong>總價格: $<span id="totalAmount">0</span></strong>
        </div>
    </div>

    <div class="delete-all-button">
        <button class="btn btn-danger" onclick="removeAllProducts()" id="deleteAll">删除全部</button>
    </div>

    <div id="emptyCartMessage" style="display: none;">
        <p>購物車為空</p>
    </div>

    <div>
        <div>
            <button class="btn btn-danger" id="backtoshop">
                <a href="/ProductTest.html">回購物商城</a>
            </button>
        </div>
    </div>






    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

    <script>
//         window.onload = function() {
//             // 獲取 input 元素
//             var productJsonInput = document.getElementById("productJson");

//             // 檢查是否找到 input 元素
//             if (productJsonInput) {
//                 // 獲取 JSON 字符串值
//                 var productJsonString = productJsonInput.value;

//                 // 解析 JSON 字符串為 JavaScript 對象
//                 var productData = JSON.parse(productJsonString);

//                 // 現在您可以在這裡使用 productData 來處理商品數據
//                 // 例如，顯示商品詳細信息或添加到購物車

//             }
//         };
        var products = [];

        //===============================頁面進入需要先載入的================================================//
        document.addEventListener("DOMContentLoaded", function () {
            // 跳转马上获取session内的购物车数据(+redis内的)
            getSessionCart().then(function () {
                // 从 cart 对象中构建新的 products 数组
                // 初始化总价格
                var totalAmountElement = document.getElementById("totalAmount");
                totalAmountElement.textContent = "0";
                //==========================勾選框相關==================================
                const selectAllCheckbox = document.getElementById("selectAll");
                const productCheckboxes = document.querySelectorAll(".productCheckbox");

                selectAllCheckbox.addEventListener("change", function () {
                    const isChecked = this.checked;
                    productCheckboxes.forEach(function (checkbox) {
                        checkbox.checked = isChecked;
                    });

                    updateTotalPrice();
                });

                // ====================检查商品是否为空==========================================
                var productRows = document.querySelectorAll("tbody tr");
                var emptyCartMessage = document.getElementById("emptyCartMessage");
                var otherElements = document.querySelectorAll(".container > *");

                if (productRows.length === 0) {
                    // 商品为空，显示空购物车消息并隐藏其他元素
                    emptyCartMessage.style.display = "block";
                    otherElements.forEach(function (element) {
                        element.style.display = "none";
                    });
                }
            });

        });
        // ==========================動態生成表格=============================================//
        function generateProductRows() {

            var productTableBody = document.getElementById("productTableBody");
            for (var i = 0; i < products.length; i++) {
                console.log(i)
                var product = products[i];
//                 var jsonString = product.description;
//                 var jsonData = JSON.parse(jsonString);
//                 var description = jsonData.description;
                var row = document.createElement("tr");
                row.innerHTML = `
            <td><input type="checkbox" class="productCheckbox"></td>
            <td>${product.name}</td>
            <td class="productPrice">$${product.price}</td>
            <td>${product.description}</td>
            <td>
                <select class="quantity-select" onchange="updateTotalPrice()" max="20">
                </select>
            </td>
            <td>
                <button class="btn btn-danger" onclick="removeProduct(this)">删除</button>
            </td>`;

                var quantitySelect = row.querySelector(".quantity-select");
                for (var j = 1; j <= 20; j++) {
                    var option = document.createElement("option");
                    option.value = j;
                    option.textContent = j;
                    quantitySelect.appendChild(option);
                }
                quantitySelect.value = product.quantity;
                productTableBody.appendChild(row);
            }
        }


        //全選被勾選時改變勾選框
        function updateSelectAll() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            var selectAllCheckbox = document.getElementById("selectAll");
            selectAllCheckbox.checked = Array.from(productCheckboxes).every(function (checkbox) {
                return checkbox.checked;
            });
        }

        //全選的時候更新總價格
        var selectAllCheckbox = document.getElementById("selectAll");
        selectAllCheckbox.addEventListener("change", function () {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            for (var i = 0; i < productCheckboxes.length; i++) {
                productCheckboxes[i].checked = this.checked;
            }
            updateTotalPrice();
        });


        //勾選更新價格跟勾選框
        //事件处理程序是在页面加载时绑定的所以必須是以通过监听父元素上的事件，根据事件的目标来确定是哪个复选框发生了变化才可以綁定到。
        var productTableBody = document.getElementById("productTableBody");
        productTableBody.addEventListener("change", function (event) {
            var target = event.target;
            if (target.classList.contains("productCheckbox")) {
                updateTotalPrice();
                updateSelectAll();
                updateSelectAllOnProductChange();
            }
        });

        // 全部被勾選全選框也被選取
        function updateSelectAllOnProductChange() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            var selectAllCheckbox = document.getElementById("selectAll");
            var allProductsSelected = Array.from(productCheckboxes).every(function (checkbox) {
                return checkbox.checked;
            });
            selectAllCheckbox.checked = allProductsSelected;
        }


        // 删除单个商品
        function removeProduct(button) {
            var row = button.parentElement.parentElement; // 获取商品所在的行
            row.remove(); // 从DOM中删除该行
            updateTotalPrice(); // 更新总价格
            updateSelectAll(); // 更新全选复选框
            var productRows = document.querySelectorAll("tbody tr");
            var emptyCartMessage = document.getElementById("emptyCartMessage");
            var deleteAllElement = document.getElementById("deleteAll");
            var otherElements = document.querySelectorAll(".container > *");

            if (productRows.length === 0) {
                // 商品为空，显示空购物车消息并隐藏其他元素
                emptyCartMessage.style.display = "block";
                otherElements.forEach(function (element) {
                    element.style.display = "none";
                    deleteAllElement.style.display = "none";
                });
            }
        }

        // 删除全部商品
        function removeAllProducts() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            productCheckboxes.forEach(function (checkbox) {
                checkbox.checked = false; // 取消选择所有商品的复选框
            });

            var productRows = document.querySelectorAll("tbody tr"); // 获取所有商品行
            productRows.forEach(function (row) {
                row.remove(); // 删除所有商品行
            });

            updateTotalPrice(); // 更新总价格
            updateSelectAll(); // 更新全选复选框

            var productRows = document.querySelectorAll("tbody tr");
            var emptyCartMessage = document.getElementById("emptyCartMessage");
            var deleteAllElement = document.getElementById("deleteAll");
            var otherElements = document.querySelectorAll(".container > *");

            if (productRows.length === 0) {
                // 商品为空，显示空购物车消息并隐藏其他元素
                emptyCartMessage.style.display = "block";
                otherElements.forEach(function (element) {
                    element.style.display = "none";
                    deleteAllElement.style.display = "none";
                });
            }
        }

        //更新總價格
        function updateTotalPrice() {
            var productPrices = document.querySelectorAll(".productPrice");
            var quantities = document.querySelectorAll(".quantity-select");
            var totalAmountElement = document.getElementById("totalAmount");
            var totalAmount = 0;

            for (var i = 0; i < productPrices.length; i++) {
                var priceText = productPrices[i].textContent;
                var numericPrice = priceText.replace(/[^\d.]/g, "");
                var price = parseFloat(numericPrice);
                var quantity = parseInt(quantities[i].value);
                var productCheckbox = productPrices[i].parentElement.querySelector(".productCheckbox");

                if (productCheckbox.checked) {
                    totalAmount += price * quantity;
                }
            }

            totalAmountElement.textContent = totalAmount;
        }

        //=======================get取得session內資訊================================//
        // 获取购物车数据并构建新的 products 数组
        function getSessionCart() {
            return fetch('/Paradisiac/Cart?action=shoppingCart', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('沒有取得回應');
                    }
                })
                .then(data => {
                    if (data.error) {
                        console.log(data.error);
                    } else {
                        products = [];
                        for (const productName in data) {
                            const cartProduct = data[productName];
                            products.push({
                                name: productName,
                                price: cartProduct.price,
                                quantity: cartProduct.quantity,
                                // 如果您希望在表格中显示商品描述，您可以设置一个默认值，例如 "No description"
                                description: cartProduct.description || "No description"
                            });
                        }


                        generateProductRows();
                    }
                });

        }




    </script>
</body>

</html>