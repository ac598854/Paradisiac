<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>會員結帳</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- 引入Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <style type="text/css">
        /* 全局背景 */
        body {
            background-image: url('https://cha103-29.s3.ap-northeast-1.amazonaws.com/pexels-jeff-ibera-1320755.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* 結帳詳情區域 */
        #checkout-details {
            background-color: rgba(255, 255, 255, 0.4); /* 半透明背景 */
            border-radius: 10px; /* 圓角 */
            padding: 20px;
            margin: 20px auto; /* 水平居中 */
            width: 80%; /* 或需要的任何百分比 */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* 盒陰影 */
        }

        /* 表格樣式 */
        #cart-items-table {
            background-color: transparent; /* 確保表格背景透明 */
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        #cart-items-table th, #cart-items-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #cart-items-table th {
            background-color: rgba(255, 255, 255, 0.8);
        }

        /* 標題樣式 */
        h2, h3 {
            text-align: center;
            color: #333; /* 或您希望的任何顏色 */
            margin: 10px 0;
        }

        /* 表單樣式 */
        form {
            background-color: transparent; /* 表單背景透明 */
            padding: 10px;
            border-radius: 5px;
        }

        label {
            margin: 10px 0;
        }

        input[type="text"], input[type="tel"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: rgba(255, 255, 255, 0.8);
        }

        /* 按鈕樣式 */
        button {
            background-color: #5cb85c; /* 確認按鈕顏色 */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4cae4c; /* 按鈕懸停效果 */
        }

        #cancel-button {
            background-color: #d9534f; /* 取消按鈕顏色 */
        }

        /* 頁尾樣式 */
        footer {
            background-color: #333; /* 您可以選擇任何您喜歡的顏色 */
            color: white;
            text-align: center;
            padding: 10px 0;
            position: relative;
            bottom: 0;
            width: 100%;
        }

        /* 為了解決可能的內容與頁腳重疊問題，確保主內容有足夠的下邊距 */
        #checkout-details {
            margin-bottom: 60px; /* 頁尾高度加上一些額外空間 */
        }
    </style>
</head>
<body>
<div id="dynamicContent"></div>  <!-- 動態內容的容器 -->



<div id="checkout-details">
    <h2>Check Out</h2>
    <table id="cart-items-table" class="table">
        <thead>
        <tr>
            <th>商品名稱</th>
            <th>單價</th>
            <th>數量</th>
            <th>小計</th>
        </tr>
        </thead>
        <tbody>
        <!-- 購物車商品將在這裡動態生成 -->
        </tbody>
    </table>
    <div class="address-container">
        <h3>Shipping address</h3>
        <form id="shipping-form">
            <label for="recipient-name">收件人姓名:</label>
            <input type="text" id="recipient-name" name="recipient-name" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人姓名！</span>

            <label for="recipient-phone">收件人電話:</label>
            <input type="tel" id="recipient-phone" name="recipient-phone" pattern="[0-9]{10}" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人電話！</span>

            <label for="recipient-address">收件人地址:</label>
            <input type="text" id="recipient-address" name="recipient-address" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人地址！</span>

            <!-- 支付方式的下拉選單 -->
            <select id="payment-method" name="payment-method" required onchange="updateStatus(this.value)">
                <option value="">選擇支付方式</option>
                <option value="1">信用卡</option>
                <option value="0">轉帳</option>
            </select>
            <!-- 信用卡資訊的文本框 -->
            <div id="credit-card-info" style="display:none;">
                <label for="card-number">信用卡號碼:</label>
                <input type="text" id="card-number" name="card-number" pattern="[0-9]{16}">
                <span class="error-message" style="color: red; display: none;">請輸入有效卡號</span>
            </div>

            <!-- 轉帳資訊的文本框 -->
            <div id="transfer-info" style="display:none;">
                <label for="account-number">轉帳帳號:</label>
                <input type="text" id="account-number" name="account-number">
                <span class="error-message" style="color: red; display: none;">請輸入有效帳戶</span>
            </div>

            <button type="submit">結帳</button>
            <a href="#" class="button-link">
                <button type="button" id="cancel-button">取消</button>
            </a>
        </form>
    </div>
</div>

<footer>
    <div id="footer"></div>  <!-- 頁尾的容器 -->
</footer>

<script>
    //==================================獲取當前頁面的路徑名稱==============================================
    let pathName = window.document.location.pathname;
    //==================================從路徑名稱中提取出項目名稱==============================================
    let projectName = pathName.substring(0, pathName.substring(1).indexOf("/") + 1);
    //==================================預設狀態為true（信用卡）==============================================
    let orderStatus = true;

    //==================================取得會員servlet URL==============================================
    //     var contextPath = window.location.pathname.substring(0, window.location.pathname.indexOf("/",1));


    $(document).ready(function(){
        // 加載頁尾
        $("#footer").load(projectName +"/front-end/index/footer.jsp");

        // 處理會員登入
        $.ajax({
            type: "POST",
            url: projectName + "/front-end/members/members.do?action=indexLogin",
            success: function(data) {
                // ... 登入邏輯
                const responseMessage = parseInt(data);
                var guided = projectName + '/front-end/index/guided.jsp';
                var guidedSignout= projectName + '/front-end/index/guidedSignout.jsp';
                if (responseMessage === 1) {
                    $("#dynamicContent").load(guided);
                } else if (responseMessage === 0) {

                    $("#dynamicContent").load(guidedSignout);
                }
            },
            error: function(error) {
                console.log("AJAX error:", error);
            }
        });
    });
    //==================================當文檔加載完成後，執行以下函數==============================================
    document.addEventListener('DOMContentLoaded', function() {
        // 從sessionStorage中獲取購物車項目，若無則設為空數組
        const cartItems = JSON.parse(sessionStorage.getItem('cartItems')) || [];
        // 如果購物車不為空，則顯示購物車項目，否則彈出提示
        if (cartItems.length > 0) {
            displayCartItems(cartItems);
        } else {
            alert("購物車是空的。");
        }

        // 獲取取消按鈕的父節點，設定其超連結為項目首頁
        let cancelLink = document.getElementById('cancel-button').parentNode;
        cancelLink.href = projectName + '/productFront.html';

        // 绑定表单提交事件处理器
        document.getElementById('shipping-form').addEventListener('submit', function(event) {
            var isValid = true;
            var inputs = this.querySelectorAll('input[required]');

            // 前端验证逻辑
            inputs.forEach(function(input) {
                var errorSpan = input.nextElementSibling;
                if (!input.validity.valid) {
                    errorSpan.style.display = 'inline';
                    isValid = false;
                } else {
                    errorSpan.style.display = 'none';
                }
            });

            // 检查支付方式相关的输入
            var paymentMethod = document.getElementById('payment-method').value;
            if (paymentMethod === "1" && !document.getElementById('card-number').validity.valid) {
                document.getElementById('card-number').nextElementSibling.style.display = 'inline';
                isValid = false;
            } else if (paymentMethod === "0" && !document.getElementById('account-number').validity.valid) {
                document.getElementById('account-number').nextElementSibling.style.display = 'inline';
                isValid = false;
            }

            // 如果验证通过，调用 handleFormSubmit 处理后续逻辑
            if (isValid) {
                handleFormSubmit(event);
            } else {
                // 如果验证未通过，阻止表单默认提交行为
                event.preventDefault();
            }
        });
    });

    //==================================顯示購物車項目==============================================
    function displayCartItems(cartItems) {
        // 獲取購物車項目表格的tbody元素
        const tableBody = document.getElementById('cart-items-table').querySelector('tbody');
        // 清空tbody的內容
        tableBody.innerHTML = '';

        // 遍歷購物車項目，為每個項目創建一個表格行
        cartItems.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>$${item.price}</td>
                <td>${item.quantity}</td>
                <td>$${item.price * item.quantity}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    //==================================處理表單提交==============================================
    function handleFormSubmit(event) {
        // 防止表單的默認提交行為
        event.preventDefault();

        var isValid = true;
        var inputs = document.querySelectorAll('#shipping-form input[required]');

        // 通用的前端验证逻辑
        inputs.forEach(function(input) {
            var errorSpan = input.nextElementSibling;
            if (!input.validity.valid) {
                errorSpan.style.display = 'inline';
                isValid = false;
            } else {
                errorSpan.style.display = 'none';
            }
        });

        // 检查支付方式相关的输入
        var paymentMethod = document.getElementById('payment-method').value;
        var cardNumber = document.getElementById('card-number');
        var accountNumber = document.getElementById('account-number');

        if (paymentMethod === "1") {
            if (cardNumber.value.trim() === "") {
                cardNumber.nextElementSibling.style.display = 'inline';
                isValid = false;
            } else {
                cardNumber.nextElementSibling.style.display = 'none';
            }
        } else if (paymentMethod === "0") {
            if (accountNumber.value.trim() === "") {
                accountNumber.nextElementSibling.style.display = 'inline';
                isValid = false;
            } else {
                accountNumber.nextElementSibling.style.display = 'none';
            }
        }

        // 如果验证通过，调用 submitOrder 函數處理提交邏輯
        if (isValid) {
            submitOrder();
        }
    }

    //==================================更新訂單狀態=============================================
    function updateStatus(value) {
        // 如果選擇的是信用卡，設置status為true，否則為false
        orderStatus = value === "1";

        // 根據選擇的支付方式顯示相應的文本框
        document.getElementById("credit-card-info").style.display = value === "1" ? "block" : "none";
        document.getElementById("transfer-info").style.display = value === "0" ? "block" : "none";
    }

    //==================================提交訂單=============================================
    function submitOrder(memNo) {
        // 獲取收件人名稱和地址
        const recipientName = document.getElementById('recipient-name').value;
        const recipientPhone = document.getElementById('recipient-phone').value;
        const recipientAddress = document.getElementById('recipient-address').value;

        // 從sessionStorage中獲取購物車項目
        const cartItems = JSON.parse(sessionStorage.getItem('cartItems')) || [];
        // 將購物車項目轉換為訂單項目列表
        const buyItemList = cartItems.map(item => ({
            productId: item.productId,  // 確保這裡使用正確的屬性名
            quantity: item.quantity,
        }));

        //刪除redis內的商品
        const productNameDelet = cartItems.map(item => ({
            productName: item.name
        }));

        productNameDelet.forEach(item => {
            console.log("刪除" + item.productName);
            deleteOne(item.productName);
        });



        // 構建訂單數據
        const orderData = {
            orderName: recipientName,
            orderPhone: recipientPhone,
            address: recipientAddress,
            status: orderStatus,
            totalAmount: calculateTotalAmount(cartItems),
            buyItemList: buyItemList
        };

        // 向伺服器發送POST請求，提交訂單數據
        fetch(`/Paradisiac/members/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData),
        })

            .then(response => {
                if (!response.ok) {
                    throw new Error('庫存不足，請重新選購！');
                }
                return response.json();
            })

            .then(data => {
                console.log('訂單創建成功:', data);
                alert('訂單創建成功');
                // 訂單創建成功後，重定向到memberOrders頁面
                window.location.href = projectName + '/memberOrders.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);  // 顯示錯誤信息
                window.location.href = projectName + '/productFront.html'; // 重定向到購物商城頁面
            });
    }

    //==================================計算購物車總金額=============================================
    function calculateTotalAmount(cartItems) {
        return cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
    //=============================刪除redis內的商品=====================================================//
    function deleteOne(productName) {
        console.log(productName);
        const productNameJSON = JSON.stringify({ productName: productName });
        const dataToSend = { action: 'delete', cartData: productNameJSON};

        fetch(projectName + '/Cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify(dataToSend)
        }).then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('沒有取得回應');
            }
        })

    }
</script>


</body>
</html>
