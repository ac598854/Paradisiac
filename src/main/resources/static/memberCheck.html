<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>會員結帳</title>
    <link rel="stylesheet" href="css/memberCheck.css"> <!-- 指向您的CSS樣式表 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<header class="flex-header">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/Paradisiac/productFront.html">購物商城</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">首頁</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">關於我們</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">聯絡我們</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <input type="text" placeholder="Search..." id="searchInput" onkeyup="handleEnter(event)">
                    <button onclick="searchProducts()">搜尋</button>
                    <li class="nav-item">
                        <a class="nav-link" href="/Paradisiac/cart/cart.html">
                            <i class="fas fa-shopping-cart"></i> <span id="cartCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">登入</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

</header>

<!-- Checkout details area where product details will be displayed -->
<div id="checkout-details">
    <h2>Check Out</h2>
    <table id="cart-items-table" class="table">
        <thead>
        <tr>
            <th>商品名稱</th>
            <th>單價</th>
            <th>數量</th>
            <th>小計</th>
        </tr>
        </thead>
        <tbody>
        <!-- 購物車商品將在這裡動態生成 -->
        </tbody>
    </table>
    <div class="address-container">
        <h3>Shipping address</h3>
        <form id="shipping-form">
            <label for="recipient-name">收件人姓名:</label>
            <input type="text" id="recipient-name" name="recipient-name" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人姓名！</span>

            <label for="recipient-phone">收件人電話:</label>
            <input type="tel" id="recipient-phone" name="recipient-phone" pattern="[0-9]{10}" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人電話！</span>

            <label for="recipient-address">收件人地址:</label>
            <input type="text" id="recipient-address" name="recipient-address" required>
            <span class="error-message" style="color: red; display: none;">請輸入收件人地址！</span>

            <!-- 支付方式的下拉選單 -->
            <select id="payment-method" name="payment-method" required onchange="updateStatus(this.value)">
                <option value="">選擇支付方式</option>
                <option value="1">信用卡</option>
                <option value="0">轉帳</option>
            </select>
            <!-- 信用卡資訊的文本框 -->
            <div id="credit-card-info" style="display:none;">
                <label for="card-number">信用卡號碼:</label>
                <input type="text" id="card-number" name="card-number" pattern="[0-9]{16}">
                <span class="error-message" style="color: red; display: none;">請輸入有效卡號</span>
            </div>

            <!-- 轉帳資訊的文本框 -->
            <div id="transfer-info" style="display:none;">
                <label for="account-number">轉帳帳號:</label>
                <input type="text" id="account-number" name="account-number">
                <span class="error-message" style="color: red; display: none;">請輸入有效帳戶</span>
            </div>

            <button type="submit">結帳</button>
            <a href="#" class="button-link">
                <button type="button" id="cancel-button">取消</button>
            </a>
        </form>
    </div>
</div>

<footer>
    <!-- 頁腳資訊 -->
</footer>

<script>
    //==================================獲取當前頁面的路徑名稱==============================================
    let pathName = window.document.location.pathname;
    //==================================從路徑名稱中提取出項目名稱==============================================
    let projectName = pathName.substring(0, pathName.substring(1).indexOf("/") + 1);
    //==================================預設狀態為true（信用卡）==============================================
    let orderStatus = true;

    //==================================當文檔加載完成後，執行以下函數==============================================
    document.addEventListener('DOMContentLoaded', function() {
        // 從sessionStorage中獲取購物車項目，若無則設為空數組
        const cartItems = JSON.parse(sessionStorage.getItem('cartItems')) || [];
        // 如果購物車不為空，則顯示購物車項目，否則彈出提示
        if (cartItems.length > 0) {
            displayCartItems(cartItems);
        } else {
            alert("購物車是空的。");
        }

        // 獲取取消按鈕的父節點，設定其超連結為項目首頁
        let cancelLink = document.getElementById('cancel-button').parentNode;
        cancelLink.href = projectName + '/productFront.html';

        // 绑定表单提交事件处理器
        document.getElementById('shipping-form').addEventListener('submit', function(event) {
            var isValid = true;
            var inputs = this.querySelectorAll('input[required]');

            // 前端验证逻辑
            inputs.forEach(function(input) {
                var errorSpan = input.nextElementSibling;
                if (!input.validity.valid) {
                    errorSpan.style.display = 'inline';
                    isValid = false;
                } else {
                    errorSpan.style.display = 'none';
                }
            });

            // 检查支付方式相关的输入
            var paymentMethod = document.getElementById('payment-method').value;
            if (paymentMethod === "1" && !document.getElementById('card-number').validity.valid) {
                document.getElementById('card-number').nextElementSibling.style.display = 'inline';
                isValid = false;
            } else if (paymentMethod === "0" && !document.getElementById('account-number').validity.valid) {
                document.getElementById('account-number').nextElementSibling.style.display = 'inline';
                isValid = false;
            }

            // 如果验证通过，调用 handleFormSubmit 处理后续逻辑
            if (isValid) {
                handleFormSubmit(event);
            } else {
                // 如果验证未通过，阻止表单默认提交行为
                event.preventDefault();
            }
        });
    });

    //==================================顯示購物車項目==============================================
    function displayCartItems(cartItems) {
        // 獲取購物車項目表格的tbody元素
        const tableBody = document.getElementById('cart-items-table').querySelector('tbody');
        // 清空tbody的內容
        tableBody.innerHTML = '';

        // 遍歷購物車項目，為每個項目創建一個表格行
        cartItems.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td>$${item.price}</td>
                <td>${item.quantity}</td>
                <td>$${item.price * item.quantity}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    //==================================處理表單提交==============================================
    function handleFormSubmit(event) {
        // 防止表單的默認提交行為
        event.preventDefault();

        // 向伺服器發送GET請求，獲取用戶會員編號
        fetch(`/Paradisiac/members/sessionInfo`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                // 如果獲取到會員編號，則提交訂單，否則提示用戶登入
                if (data && data.memno) {
                    submitOrder(data.memno);
                } else {
                    alert("請先登入。");
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    //==================================更新訂單狀態=============================================
    function updateStatus(value) {
        // 如果選擇的是信用卡，設置status為true，否則為false
        orderStatus = value === "1";

        // 根據選擇的支付方式顯示相應的文本框
        document.getElementById("credit-card-info").style.display = value === "1" ? "block" : "none";
        document.getElementById("transfer-info").style.display = value === "0" ? "block" : "none";
    }

    //==================================提交訂單=============================================
    function submitOrder(memNo) {
        // 獲取收件人名稱和地址
        const recipientName = document.getElementById('recipient-name').value;
        const recipientPhone = document.getElementById('recipient-phone').value;
        const recipientAddress = document.getElementById('recipient-address').value;

        // 從sessionStorage中獲取購物車項目
        const cartItems = JSON.parse(sessionStorage.getItem('cartItems')) || [];
        // 將購物車項目轉換為訂單項目列表
        const buyItemList = cartItems.map(item => ({
            productId: item.productId,  // 確保這裡使用正確的屬性名
            quantity: item.quantity
        }));

        // 構建訂單數據
        const orderData = {
            orderName: recipientName,
            orderPhone: recipientPhone,
            address: recipientAddress,
            status: orderStatus,
            totalAmount: calculateTotalAmount(cartItems),
            buyItemList: buyItemList
        };

        // 向伺服器發送POST請求，提交訂單數據
        fetch(`/Paradisiac/members/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData),
        })
            .then(response => response.json())
            .then(data => {
                console.log('訂單創建成功:', data);
                alert('訂單創建成功');
                // 訂單創建成功後，重定向到memberOrders頁面
                window.location.href = projectName + '/memberOrders.html';
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    //==================================計算購物車總金額=============================================
    function calculateTotalAmount(cartItems) {
        return cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
</script>


</body>
</html>
