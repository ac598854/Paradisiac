<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title >購物車</title>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css"
	rel="stylesheet">



<style>
body {
	background-color: #fff5ee; /* 這裡的#808080代表灰色，你可以根據需要更改顏色 */
	margin: 0; /* 可以清除body的預設margin，使背景色填滿整個頁面 */
}
/* 为包含"删除全部"按钮的<div>元素添加样式 */
.delete-all-button {
	position: absolute;
	top: 30px;
	right: 75px;
	padding: 10px;
}

table {
	background-color: #ffffff;
	margin-top: 100px;
}
/* 为表格的列添加样式以确保按钮不会遮挡内容 */
.table th, .table td {
	position: relative;
}

/* 样式用于购物车为空消息 */
#emptyCartMessage {
	display: none;
	text-align: center;
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
}

/* 使用伪元素添加空购物车图标 */
#emptyCartMessage::before {
	content: "\1F6D2";
	/* Unicode字符编码，这里使用购物车图标 */
	font-size: 100px;
	display: block;
}
#backtoshop {
            position: absolute;
            top: 10px; /* 調整 top 的值使按鈕出現在表格的上方 */
            left: 10px; /* 調整 left 的值使按鈕出現在表格的左邊 */
            right: 10px;
            padding: 10px;
            font-size: 2em; /* 調整字體大小為 2em 或其他你希望的大小 */
            background-color: #00ffff;
            color: #ff0000
        }

.payInfoBox {
    display: flex;
    flex-direction: row; /* 將元素排列成水平方向 */
    align-items: center;
}

.totalPrice {
    font-size: 1.5em; /* 修改字體大小為 1.5em 或其他你希望的大小 */
}

.totalPrice span {
    font-weight: bold;
}

.payInfoBox p {
    margin: 5px 10px; /* 調整左右邊距，使元素之間有一些間距 */
    white-space: nowrap;
    display:inline-block;
}

#back{
	display:none;
}

</style>
</head>

<body>

	<div class="container" id="shopUrl">
		<div>
			<div>
				<button  id="backtoshop">
					<a href="#" id="shoppingMallLink">購物商城</a>
				</button>
			</div>
		</div>
		<table class="table table-bordered">
			<thead>
				<tr>
					<th></th>
					<th>商品名稱</th>
					<th>價格</th>
					<th>描述</th>
					<th>數量</th>
                    <th>
                        <button class="btn btn-danger" onclick="removeAllProducts()"id="deleteAll">删除全部</button>
                    </th>
				</tr>
			</thead>
			<tbody id="productTableBody">
			</tbody>
		</table>
		<table class="checkoutBox" id="checkoutBar">
			<tfoot>
				<tr>
					<td class="carttitleBox">
						<div class="form-check">
							<input type="checkbox" class="form-check-input" id="selectAll">
							<label class="form-check-label" for="selectAll">全選</label>
						</div>
					</td>
                        <td class="payInfoBox">
                            <p>總價格: $<span id="totalAmount">0</span></p>
                            <p>活動共折抵：<span><i>$</i>25,106</span></p>
                            <p>結帳總金額：<span><i class="totalPriceMoney">$</i><i class="totalPrice">35,766<i></i></i></span></p>
                        </td>
					<td class="checkoutButton selected">
						<div id="productInfo">
							<form id="cartForm">
								<input type="hidden" name="productJson" id="productJson">
								<button class="btn btn-danger" type="button" onclick="redirectToCheckout()">結帳</button>
							</form>
						</div></td>
				</tr>
			</tfoot>
		</table>
	</div>

	<button id='back'>
		<a href="#" id="shoppingMallLink2">購物商城</a>
	</button>


	<div id="emptyCartMessage" style="display: none;">
		<p>購物車為空</p>
	</div>








	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

	<script>
//================================動態URL=======================================================//
		let pathName = window.document.location.pathname;
		let projectName = pathName.substring(0, pathName.substring(1).indexOf("/") + 1);

		let shoppingMallLink = document.getElementById("shoppingMallLink");
		let shoppingMallLink2 = document.getElementById("shoppingMallLink2");
		shoppingMallLink2.href = projectName + "/productFront.html";
		shoppingMallLink.href = projectName + "/productFront.html";



//===============================頁面進入需要先載入的================================================//
        document.addEventListener("DOMContentLoaded", function () {
        	var products = [];
            // 跳转马上获取session内的购物车数据(+redis内的)
            getSessionCart().then(function () {
                var totalAmountElement = document.getElementById("totalAmount");
                totalAmountElement.textContent = "0";

              const selectAllCheckbox = document.getElementById("selectAll");
              const productCheckboxes = document.querySelectorAll(".productCheckbox");

              selectAllCheckbox.addEventListener("change", function () {
                  const isChecked = this.checked;
                  productCheckboxes.forEach(function (checkbox) {
                      checkbox.checked = isChecked;
                  });

                  updateTotalPrice();

              });
              cartEmpty();
            });

        });
// ============================檢查商品是否為空=============================================//
		function cartEmpty(){
				console.log('檢查購物車是否為空')
                var productRows = document.querySelectorAll("tbody tr");
                var emptyCartMessage = document.getElementById("emptyCartMessage");
                var otherElements = document.querySelectorAll(".container > *");
                var shoppingMallLink = document.getElementById("back");

                if (products.length === 0 || productRows.length === 0) {
                	// 商品為空，顯示空購物車訊息並隱藏其他元素
                    emptyCartMessage.style.display = "block";
                    shoppingMallLink.style.display = "block"
                    otherElements.forEach(function (element) {
                        element.style.display = "none";
                    });
                }
		}
// ==========================處理結帳事件=============================================//
function handleCheckout(event) {
	event.preventDefault(); // 阻止表單的默認提交行為


	// 將購物車的商品資料存儲到 sessionStorage
	sessionStorage.setItem('cartItems', JSON.stringify(products));
	// 打印即將存儲的數據以供檢查
	console.log("Storing cart items: ", products);

	// 重定向到 memberCheck 頁面
	window.location.href = projectName + '/memberCheck.html';
}


function redirectToCheckout() {
	// 將購物車的商品資料存儲到 sessionStorage
	sessionStorage.setItem('cartItems', JSON.stringify(products));

	// 重定向到 memberCheck 頁面
	window.location.href = projectName + '/memberCheck.html';
}
// ==========================動態生成表格=============================================//
        function generateProductRows() {
            var productTableBody = document.getElementById("productTableBody");

            for (var i = 0; i < products.length; i++) {
                var product = products[i];
                var row = document.createElement("tr");
                row.innerHTML = `
            <td><input type="checkbox" class="productCheckbox"></td>
            <td>${product.name}</td>
            <td class="productPrice">$${product.price}</td>
            <td>${product.description}</td>
            <td>
                <select class="quantity-select" onchange="changeQuantity('${product.name}', this.value)" max=${product.stock}>
                </select>
            </td>
            <td>
 				 <button class="btn btn-danger" onclick="removeProductAndDelete('${product.name}', this)">删除</button>
            </td>`;

                var quantitySelect = row.querySelector(".quantity-select");
                for (var j = 1; j <= product.stock; j++) {
                    var option = document.createElement("option");
                    option.value = j;
                    option.textContent = j;
                    quantitySelect.appendChild(option);
                }
                quantitySelect.value = product.quantity;
                productTableBody.appendChild(row);
            }
        }

//================================勾選框相關================================//
        //全選被勾選時改變勾選框
        function updateSelectAll() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            var selectAllCheckbox = document.getElementById("selectAll");
            selectAllCheckbox.checked = Array.from(productCheckboxes).every(function (checkbox) {
                return checkbox.checked;
            });
        }

        //全選的時候更新總價格
        var selectAllCheckbox = document.getElementById("selectAll");
        selectAllCheckbox.addEventListener("change", function () {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            for (var i = 0; i < productCheckboxes.length; i++) {
                productCheckboxes[i].checked = this.checked;
            }
            updateTotalPrice();
        });


        //勾選更新價格跟勾選框
        //事件處理程序是在頁面載入時綁定的所以必須是以透過監聽父元素上的事件，根據事件的目標來確定是哪個複選框發生了變化才可以綁定到。
        var productTableBody = document.getElementById("productTableBody");
        productTableBody.addEventListener("change", function (event) {
            var target = event.target;
            if (target.classList.contains("productCheckbox")) {
                updateTotalPrice();
                updateSelectAll();
                updateSelectAllOnProductChange();
            }
        });
        function updateSelectAllOnProductChange() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            var selectAllCheckbox = document.getElementById("selectAll");
            var allProductsSelected = Array.from(productCheckboxes).every(function (checkbox) {
                return checkbox.checked;
            });
            selectAllCheckbox.checked = allProductsSelected;
        }
//================================刪除單一商品================================//
 function removeProductAndDelete(productname, button) {
            removeProduct(button);
            deleteOne(productname);
        }
        function removeProduct(button) {
            var row = button.parentElement.parentElement; // 取得商品所在的行
            row.remove();
            updateTotalPrice();
            updateSelectAll(); // 更新全選複選框
            cartEmpty();
        }

 //======================================= 删除全部商品================================//
        function removeAllProducts() {
            var productCheckboxes = document.querySelectorAll(".productCheckbox");
            productCheckboxes.forEach(function (checkbox) {
                checkbox.checked = false; // 取消選取所有商品的複選框
            });

            var productRows = document.querySelectorAll("tbody tr"); // 取得所有商品行
            productRows.forEach(function (row) {
                row.remove(); // 删除所有商品行
            });
            deleteAll();
            updateTotalPrice();
            updateSelectAll();
            cartEmpty();
        }
//=======================================更新總價格================================//
        function updateTotalPrice() {
            var productPrices = document.querySelectorAll(".productPrice");
            var quantities = document.querySelectorAll(".quantity-select");
            var totalAmountElement = document.getElementById("totalAmount");
            var totalAmount = 0;

            for (var i = 0; i < productPrices.length; i++) {
                var priceText = productPrices[i].textContent;
                var numericPrice = priceText.replace(/[^\d.]/g, "");
                var price = parseFloat(numericPrice);
                var quantity = parseInt(quantities[i].value);
                var productCheckbox = productPrices[i].parentElement.querySelector(".productCheckbox");

                if (productCheckbox.checked) {
                    totalAmount += price * quantity;
                }
            }

            totalAmountElement.textContent = totalAmount;
        }
//=====================================變更數量.總價格=====================================//
        function changeQuantity(productName,quantity){
        	updateTotalPrice();
        	changeQuantity(productName,quantity);
        }

//=======================================get取得session內資訊================================//
        function getSessionCart() {
            return fetch(projectName + '/Cart', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('沒有取得回應');
                    }
                })
                .then(data => {
                    if (data.error) {
                        console.log(data.error);
                    } else {
                        products = [];
                        if (Object.keys(data).length === 0) {
                            // 如果購物車是空的，呼叫 cartEmpty 函數
                            cartEmpty();
                        } else {
                        products = [];
                        for (const productName in data) {
                            const cartProduct = data[productName];
                            products.push({
                            	productId:cartProduct.productId,
                                name: productName,
                                price: cartProduct.price,
                                quantity: cartProduct.quantity,
                                description: cartProduct.description || "No description",
                                stock:cartProduct.stock
                            });
                        }
                        generateProductRows();
                    }
                }
                });
        }
//=============================刪除一個=====================================================//
        function deleteOne(productName) {
        	const productNameJSON = JSON.stringify({ productName: productName });
            const dataToSend = { action: 'delete', cartData: productNameJSON};

            fetch(projectName + '/Cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(dataToSend)
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('沒有取得回應');
                }
            })
                .then(data => {
                    if (data.delete) {
                        alert(data.delete);
                    }
                });
        }
//=============================刪除全部=====================================================//
        function deleteAll() {
        	const productJSON = JSON.stringify({ });
			console.log("刪除全部")
			const dataToSend = { action: 'deleteAll' ,cartData: productJSON};
            fetch(projectName + '/Cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(dataToSend)
            }).then(response => {
                if (response.ok) {
                	console.log("刪除全部")
                } else {
                    throw new Error('沒有取得回應');
                }
            })
        }
 //=============================變更數量=====================================================//
		function changeQuantity(productName,quantity) {
			const productJSON = JSON.stringify({productName: productName , quantity: quantity})
			const dataToSend = { action: 'changeQuantity' , cartData: productJSON}
				fetch(projectName + '/Cart',{
					method: 'POST',
					 headers: {
		                    'Content-Type': 'application/json;charset=utf-8'
		             },
		             body: JSON.stringify(dataToSend)
				}).then(response => {
	                if (response.ok) {
	                	console.log("更改"+productName+"數量")
	                } else {
	                    throw new Error('沒有取得回應');
	                }
	            })
		}


    </script>
</body>

</html>